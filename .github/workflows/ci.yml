name: Monorepo pnpm CI

on:
  pull_request:
    branches: ["main", "develop"]

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # 1. ë¦°íŠ¸, ë¹Œë“œ, í…ŒìŠ¤íŠ¸ í•œ ë²ˆì— ì‹¤í–‰ (ë³€ê²½ëœ íŒ¨í‚¤ì§€ë§Œ)
      - name: Run Lint & Build (Affected)
        run: npx turbo run lint build --filter=...[origin/develop]
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}

      # 2. í…ŒìŠ¤íŠ¸ (í•­ìƒ ì‹¤í–‰ - ë¦¬í¬íŠ¸ ìƒì„±ì„ ìœ„í•´)
      # í•„í„°(...[origin/main])ë¥¼ ì“°ë©´ ë³€ê²½ì‚¬í•­ ì—†ì„ ë•Œ í…ŒìŠ¤íŠ¸ê°€ ì•ˆ ëŒì•„ê°€ì„œ ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì•ˆ ìƒê¹ë‹ˆë‹¤.
      # ê·¸ëž˜ì„œ ë¦¬í¬íŠ¸ë¥¼ ë³´ë ¤ë©´ í•„í„° ì—†ì´(ë˜ëŠ” backend ëª…ì‹œ) ê°•ì œë¡œ ëŒë ¤ì•¼ í•©ë‹ˆë‹¤.
      - name: Run Unit Tests
        run: npx turbo run test:ci --filter=backend
        continue-on-error: true

      # 2. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì‹œê°í™”
      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ðŸ§ª Unit Test Results
          path: "packages/**/junit.xml"
          reporter: jest-junit

      # 3. ìš”ì•½ í˜„í™©íŒ
      - name: ðŸ“Š CI Summary
        if: always()
        run: |
          echo "ë¦°íŠ¸, ë¹Œë“œ, í…ŒìŠ¤íŠ¸ ìƒì„¸ ê²°ê³¼ëŠ” ìƒë‹¨ **Checks** íƒ­ì—ì„œ í™•ì¸" >> $GITHUB_STEP_SUMMARY
