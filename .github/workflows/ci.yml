name: Monorepo pnpm CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # 1. ë¦°íŠ¸, ë¹Œë“œ, í…ŒìŠ¤íŠ¸ í•œ ë²ˆì— ì‹¤í–‰ (ë³€ê²½ëœ íŒ¨í‚¤ì§€ë§Œ)
      - name: Run Lint, Build & Test (Affected)
        run: npx turbo run lint build test:ci --filter=...[origin/main]
        continue-on-error: true

      # 2. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì‹œê°í™”
      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ðŸ§ª Unit Test Results
          path: "packages/**/junit.xml"
          reporter: jest-junit

      # 3. ë„ì»¤ í‘¸ì‹œ (ì¸ìŠ¤í„´ìŠ¤ ìƒê¸°ê¸° ì „ê¹Œì§€ ë¹„í™œì„±í™”)
      - name: Docker Login & Push (Backend)
        if: false
        # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "${{ secrets.NCP_SECRET_KEY }}" | docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.NCP_ACCESS_KEY }} --password-stdin
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/backend:latest -f ./packages/backend/Dockerfile .
          docker push ${{ secrets.DOCKER_REGISTRY }}/backend:latest

      # 4. ìš”ì•½ í˜„í™©íŒ
      - name: ðŸ“Š CI Summary
        if: always()
        run: |
          echo "ë¦°íŠ¸, ë¹Œë“œ, í…ŒìŠ¤íŠ¸ ìƒì„¸ ê²°ê³¼ëŠ” ìƒë‹¨ **Checks** íƒ­ì—ì„œ í™•ì¸ >> $GITHUB_STEP_SUMMARY
