name: Monorepo pnpm CI

on:
  pull_request:
    branches: ["main", "develop"]

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # 1. ë¦°íŠ¸, ë¹Œë“œ ì‹¤í–‰ (ë³€ê²½ëœ íŒ¨í‚¤ì§€ë§Œ)
      - name: Run Lint & Build (Affected)
        run: npx turbo run lint build --filter=...[origin/develop]

      # 2. ìœ ë‹› í…ŒìŠ¤íŠ¸ (í•­ìƒ ì‹¤í–‰)
      - name: Run Unit Tests
        run: npx turbo run test:ci --filter=backend

      # 3. E2E í…ŒìŠ¤íŠ¸ (MySQL ì—°ë™)
      - name: Run E2E Tests
        run: |
          cd packages/backend
          npm run test:e2e:ci
        env:
          NODE_ENV: development
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USERNAME: root
          DB_PASSWORD: password
          DB_DATABASE: test_db
          JEST_JUNIT_OUTPUT_NAME: "junit-e2e.xml"


      # 2. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì‹œê°í™”
      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ðŸ§ª Unit & E2E Test Results
          path: "packages/**/junit*.xml"
          reporter: jest-junit

      # 3. ìš”ì•½ í˜„í™©íŒ
      - name: ðŸ“Š CI Summary
        if: always()
        run: |
          echo "ë¦°íŠ¸, ë¹Œë“œ, í…ŒìŠ¤íŠ¸ ìƒì„¸ ê²°ê³¼ëŠ” ìƒë‹¨ **Checks** íƒ­ì—ì„œ í™•ì¸" >> $GITHUB_STEP_SUMMARY
