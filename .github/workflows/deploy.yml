name: Deploy to Server

on:
  workflow_run:
    workflows: ["Build and Push Image"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server components using SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            START_TIME=$(date +%s)
            
            # 1. íŠ¸ë¦¬ê±°ëœ ì •ë³´ í™•ì¸ (ë¸Œëœì¹˜ ë° ì»¤ë°‹í•´ì‹œ)
            # workflow_runìœ¼ë¡œ ì‹¤í–‰ëœ ê²½ìš° í•´ë‹¹ ì •ë³´ ì‚¬ìš©, ì•„ë‹ˆë©´ ìˆ˜ë™ ì‹¤í–‰ìœ¼ë¡œ ê°„ì£¼í•˜ê³  develop/HEAD ì‚¬ìš©
            TARGET_BRANCH="${{ github.event.workflow_run.head_branch }}"
            HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
            
            if [ -z "$TARGET_BRANCH" ]; then TARGET_BRANCH="develop"; fi
            if [ -z "$HEAD_SHA" ]; then 
              # ìˆ˜ë™ ì‹¤í–‰ ì‹œ í˜„ì¬ ì„œë²„ì— ìˆëŠ” git ê¸°ì¤€ ìµœì‹  í•´ì‹œ ì‚¬ìš© (ì£¼ì˜ í•„ìš”)
              HEAD_SHA=$(git rev-parse HEAD) 
            fi

            # 7ìë¦¬ Short SHA ìƒì„± -> ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì‚¬ìš©
            SHORT_SHA=$(echo $HEAD_SHA | cut -c1-7)
            IMAGE_TAG="sha-${SHORT_SHA}"

            echo "ğŸš€ Starting Deployment..."
            echo "Target Branch: $TARGET_BRANCH"
            echo "Target Image Tag: $IMAGE_TAG"

            # 2. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            if [ ! -d "web23-PSI" ]; then
              git clone https://github.com/boostcampwm2025/web23-PSI.git
            fi
            cd web23-PSI
            
            # 3. ìµœì‹  ì„¤ì •(docker-compose ë“±) ê°€ì ¸ì˜¤ê¸°
            # í•´ë‹¹ ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
            git fetch origin $TARGET_BRANCH
            git checkout $TARGET_BRANCH
            git pull origin $TARGET_BRANCH
            
            # 4. í™˜ê²½ ë³€ìˆ˜ ì£¼ì… (Docker Composeê°€ ì°¸ì¡°í•¨)
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            export IMAGE_TAG=$IMAGE_TAG
            
            # 5. ë°°í¬ (ì´ë¯¸ì§€ Pull & Up)
            echo "Download new image ($IMAGE_TAG)..."
            docker-compose -f packages/backend/docker-compose.dev.yml pull
            
            echo "Deploy containers..."
            # í˜¹ì‹œ ëª¨ë¥¼ ê³ ì•„ ì»¨í…Œì´ë„ˆ ë°©ì§€(--remove-orphans)
            docker-compose -f packages/backend/docker-compose.dev.yml up -d --remove-orphans
            
            # 6. ì •ë¦¬ (ì´ì „ ë²„ì „ ì´ë¯¸ì§€ ì‚­ì œ)
            docker image prune -f

            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "âœ… Deployment Complete"
            echo "â±ï¸ Time taken: ${DURATION} seconds"
