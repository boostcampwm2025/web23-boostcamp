name: Deploy to Production Server

on:
  workflow_run:
    workflows: ["Build and Push Production Image"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g. latest, v1.0.0, sha-xxxxxxx)'
        required: true
        default: 'latest'

jobs:
  verify-blackbox:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run Blackbox Tests
        run: |
          cd packages/backend
          npm run test:blackbox
        env:
          NODE_ENV: test
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USERNAME: root
          DB_PASSWORD: password
          DB_DATABASE: test_db
          # í•„ìš”í•œ ë‹¤ë¥¸ í™˜ê²½ ë³€ìˆ˜ë“¤ë„ ì—¬ê¸°ì— ì¶”ê°€ (ì˜ˆ: CLOVA API ë“±)
          # ë§Œì•½ ë¸”ë™ë°•ìŠ¤ í…ŒìŠ¤íŠ¸ê°€ ì™¸ë¶€ APIë¥¼ í˜¸ì¶œí•œë‹¤ë©´ Secretsê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ
          CLOVA_SPEECH_API_URL: ${{ secrets.CLOVA_SPEECH_API_URL }}
          CLOVA_SPEECH_API_KEY: ${{ secrets.CLOVA_SPEECH_API_KEY }}
          CLOVA_API_URL: ${{ secrets.CLOVA_API_URL }}
          CLOVA_API_KEY: ${{ secrets.CLOVA_API_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          JWT_ACCESS_TOKEN_EXPIRATION: 12h
          JWT_REFRESH_TOKEN_EXPIRATION: 14d
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          OAUTH_REDIRECT_URI: http://localhost:8000/auth/signup/oauth


  deploy:
    needs: [verify-blackbox]
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual Trigger: Deploying version ${{ inputs.version }}"
            echo "TARGET_VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          else
            echo "Auto Trigger: Deploying hardcoded test version"
            # ìë™ ë°°í¬ëŠ” í•­ìƒ hardcoded version
            echo "TARGET_VERSION=vTEST-DEPLOY" >> $GITHUB_ENV
          fi

      - name: Deploy to Server components using SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USER }}
          password: ${{ secrets.PRODUCTION_SERVER_PASSWORD }}
          port: ${{ secrets.PRODUCTION_SERVER_PORT }}
          script: |
            START_TIME=$(date +%s)
            IMAGE_TAG="${{ env.TARGET_VERSION }}"
            
            echo "ğŸš€ Starting Production Deployment..."
            echo "Target Image Tag: $IMAGE_TAG"
            
            # 1. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            if [ ! -d "web23-PSI" ]; then
              git clone https://github.com/boostcampwm2025/web23-PSI.git
            fi
            cd web23-PSI
            
            # 2. ìµœì‹  ì„¤ì •(docker-compose.prod.yml ë“±) ê°€ì ¸ì˜¤ê¸°
            git fetch origin main
            git checkout main
            git pull origin main
            
            # 3. í™˜ê²½ ë³€ìˆ˜ ì£¼ì…
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            export IMAGE_TAG=$IMAGE_TAG
            # DB ì •ë³´ ë“±ì€ .env íŒŒì¼ì´ ì„œë²„ì— ì´ë¯¸ ì¡´ì¬í•œë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜ Secretsì—ì„œ ì£¼ì… í•„ìš”
            
            # 4. ë°°í¬ (ì´ë¯¸ì§€ Pull & Up)
            echo "Download new image ($IMAGE_TAG)..."
            docker-compose -f packages/backend/docker-compose.prod.yml pull
            
            echo "Deploy containers..."
            docker-compose -f packages/backend/docker-compose.prod.yml up -d --remove-orphans
            
            # 5. ì •ë¦¬ (ì´ì „ ë²„ì „ ì´ë¯¸ì§€ ì‚­ì œ)
            echo y | docker image prune -a -f
            
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            echo "âœ… Deployment Complete"
            echo "â±ï¸ Time taken: ${DURATION} seconds"
